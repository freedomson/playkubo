# SERVICE NODEJS
- block:
  - name: Ensure directory structure exists
    file:
      path: '/home/pi/src/{{ item.path }}'
      state: directory
    with_filetree: '{{playbook_dir}}/roles/playkubo/templates/services/src'
    when: item.state == 'directory' and (item.path | search("node_modules")) == false

  - name: Ensure files are populated from templates
    template:
      src: '{{ item.src }}'
      dest: '/home/pi/src/{{ item.path }}'
    with_filetree: '{{playbook_dir}}/roles/playkubo/templates/services/src'
    when: item.state == 'file' and (item.path | search(".jpeg")) == false

  - name: Copy public files from a directory to remote server
    copy:
      src: '{{playbook_dir}}/roles/playkubo/templates/services/src/public/'
      dest: '/home/pi/src/public'


- block:
  - name:  Booting captivity portal [http://192.168.10.1:8080/]
    become: true
    become_method: sudo
    shell: cd /home/pi/src/ ; npm install
    register: dockerrun

  - debug: msg="{{ dockerrun.stdout }}"

- block:
  - name:  Starting captivity portal [http://192.168.10.1:8080/]
    become: true
    become_method: sudo
    shell: node /home/pi/src/server.js &
    register: dockerrun

  - debug: msg="{{ dockerrun.stdout }}"
  
# - block:
#   - template:
#       src: "{{playbook_dir}}/roles/playkubo/templates/services/nodejs.dockerfile"
#       dest: /home/pi/nodejs.dockerfile
#       owner: pi
#       mode: 0775

  # - name: Installing captivity portal [nodejs]
  #   become: true
  #   become_method: sudo
  #   shell: docker build -t playkubo -f nodejs.dockerfile .
  #   register: dockerinstall

  # - debug: msg="{{ dockerinstall.stdout }}"

  # - name:  Starting captivity portal [http://192.168.10.1:8080/]
  #   become: true
  #   become_method: sudo
  #   shell: docker run -d -p 8080:8080 -ti playkubo
  #   register: dockerrun

  # - debug: msg="{{ dockerrun.stdout }}"