# SERVICE NODEJS
- block:
  - name: Ensure directory structure exists
    file:
      path: '/home/pi/src/{{ item.path }}'
      state: directory
    with_filetree: '{{playbook_dir}}/roles/playkubo/templates/services/src'
    when: item.state == 'directory' and (item.path | search("node_modules")) == false

  - name: Ensure files are populated from templates
    template:
      src: '{{ item.src }}'
      dest: '/home/pi/src/{{ item.path }}'
    with_filetree: '{{playbook_dir}}/roles/playkubo/templates/services/src'
    when: item.state == 'file' and (item.path | search(".jpeg")) == false

  - name: Copy public files from a directory to remote server
    copy:
      src: '{{playbook_dir}}/roles/playkubo/templates/services/src/public/'
      dest: '/home/pi/src/public'


- block:
  - name:  Rebooting captivity portal [http://192.168.10.1:8080/]
    shell: cd /home/pi/src/ ; npm install
    register: dockerrun

  - debug: msg="{{ dockerrun.stdout }}"

- block:
  - name:  Stop captivity portal if present
    become: true
    become_method: sudo
    shell: pgrep node | xargs kill -9
    register: dockerrunkill
    ignore_errors: yes
  
  - debug: msg="{{ dockerrunkill.stdout }}"

  - name:  Starting captivity portal [http://192.168.10.1:8080/]
    shell: cd /home/pi/src ; npm start &
    register: dockerrun

  - debug: msg="{{ dockerrun.stdout }}"